<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-color: #30363d;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --accent-green: #3fb950;
      --accent-red: #f85149;
      --accent-blue: #58a6ff;
      --accent-purple: #a371f7;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    body {
      font-family: 'JetBrains Mono', 'SF Mono', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--accent-red), var(--accent-green));
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .logo-text {
      font-weight: 600;
      font-size: 14px;
      letter-spacing: -0.5px;
    }
    
    .logo-text span {
      color: var(--accent-blue);
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-red);
    }
    
    .status-dot.connected {
      background: var(--accent-green);
    }
    
    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn:hover {
      background: var(--border-color);
      border-color: var(--text-muted);
    }
    
    .btn-primary {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: #fff;
      font-weight: 500;
    }
    
    .btn-primary:hover {
      background: #4393e6;
    }
    
    .btn-danger {
      color: var(--accent-red);
    }
    
    .btn-danger:hover {
      background: rgba(248, 81, 73, 0.15);
      border-color: var(--accent-red);
    }
    
    /* Main Container */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    /* Connect Screen */
    .connect-screen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }
    
    .connect-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 40px;
      max-width: 420px;
      width: 100%;
      text-align: center;
    }
    
    .connect-icon {
      width: 80px;
      height: 80px;
      background: var(--bg-tertiary);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 36px;
    }
    
    .connect-card h2 {
      font-size: 20px;
      margin-bottom: 12px;
    }
    
    .connect-card p {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 24px;
    }
    
    .connect-btn {
      width: 100%;
      padding: 14px 20px;
      background: #000;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: #fff;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s;
      margin-bottom: 16px;
    }
    
    .connect-btn:hover {
      background: #1a1a1a;
      border-color: var(--text-muted);
    }
    
    .connect-btn img {
      width: 20px;
      height: 20px;
    }
    
    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 11px;
    }
    
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-color);
    }
    
    .token-input-group {
      display: flex;
      gap: 8px;
    }
    
    .token-input-group input {
      flex: 1;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 12px;
    }
    
    .token-input-group input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }
    
    .token-input-group input::placeholder {
      color: var(--text-muted);
    }
    
    /* Columns */
    .columns {
      flex: 1;
      display: flex;
    }
    
    .column {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
    }
    
    .column:last-child {
      border-right: none;
    }
    
    .column-header {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .column-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .column.previous .column-header {
      border-top: 3px solid var(--accent-red);
    }
    
    .column.current .column-header {
      border-top: 3px solid var(--accent-green);
    }
    
    .column.previous .column-title {
      color: var(--accent-red);
    }
    
    .column.current .column-title {
      color: var(--accent-green);
    }
    
    .version-select {
      padding: 4px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
    }
    
    .column-content {
      flex: 1;
      overflow: auto;
      background: var(--bg-primary);
      position: relative;
    }
    
    .screen-preview {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    
    .screen-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }
    
    /* Empty States */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 32px;
      text-align: center;
    }
    
    .empty-icon {
      width: 64px;
      height: 64px;
      background: var(--bg-tertiary);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      font-size: 28px;
    }
    
    .empty-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .empty-desc {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.6;
      max-width: 220px;
    }
    
    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Version Info */
    .version-info {
      position: absolute;
      bottom: 12px;
      left: 12px;
      right: 12px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 11px;
    }
    
    .version-info-label {
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    
    .version-info-name {
      color: var(--text-primary);
      font-weight: 500;
    }
    
    /* Status Bar */
    .status-bar {
      padding: 8px 20px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .status-node {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-node-type {
      padding: 2px 6px;
      background: var(--accent-purple);
      color: #fff;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }
    
    /* Hidden */
    .hidden {
      display: none !important;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.98); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <div class="logo-icon">‚éã</div>
      <div class="logo-text">Design<span>Diff</span></div>
    </div>
    <div class="header-actions">
      <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Not connected</span>
      </div>
      <button class="btn btn-danger hidden" id="disconnectBtn">Disconnect</button>
    </div>
  </div>
  
  <div class="main-container">
    <!-- Connect Screen -->
    <div class="connect-screen" id="connectScreen">
      <div class="connect-card">
        <div class="connect-icon">üîó</div>
        <h2>Connect to Figma</h2>
        <p>Connect your Figma account to access version history and compare designs across different versions.</p>
        
        <button class="connect-btn" id="connectBtn">
          <svg width="20" height="20" viewBox="0 0 38 57" fill="none">
            <path d="M19 28.5C19 23.2533 23.2533 19 28.5 19C33.7467 19 38 23.2533 38 28.5C38 33.7467 33.7467 38 28.5 38C23.2533 38 19 33.7467 19 28.5Z" fill="#1ABCFE"/>
            <path d="M0 47.5C0 42.2533 4.25329 38 9.5 38H19V47.5C19 52.7467 14.7467 57 9.5 57C4.25329 57 0 52.7467 0 47.5Z" fill="#0ACF83"/>
            <path d="M19 0V19H28.5C33.7467 19 38 14.7467 38 9.5C38 4.25329 33.7467 0 28.5 0H19Z" fill="#FF7262"/>
            <path d="M0 9.5C0 14.7467 4.25329 19 9.5 19H19V0H9.5C4.25329 0 0 4.25329 0 9.5Z" fill="#F24E1E"/>
            <path d="M0 28.5C0 33.7467 4.25329 38 9.5 38H19V19H9.5C4.25329 19 0 23.2533 0 28.5Z" fill="#A259FF"/>
          </svg>
          Connect with Figma
        </button>
        
        <div class="divider">or paste token</div>
        
        <div class="token-input-group">
          <input type="password" id="tokenInput" placeholder="Paste access token here...">
          <button class="btn btn-primary" id="saveTokenBtn">Save</button>
        </div>
      </div>
    </div>
    
    <!-- Main View -->
    <div class="columns hidden" id="mainView">
      <!-- Previous Column -->
      <div class="column previous">
        <div class="column-header">
          <span class="column-title">‚Üê Previous</span>
          <select class="version-select" id="previousVersionSelect">
            <option value="">Select version...</option>
          </select>
        </div>
        <div class="column-content">
          <div id="previousPreview" class="screen-preview">
            <div class="empty-state">
              <div class="empty-icon">‚èÆ</div>
              <div class="empty-title">Select a version</div>
              <div class="empty-desc">Choose a version from the dropdown to compare</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Current Column -->
      <div class="column current">
        <div class="column-header">
          <span class="column-title">Current ‚Üí</span>
          <button class="btn" id="refreshBtn">‚Üª Refresh</button>
        </div>
        <div class="column-content">
          <div id="currentPreview" class="screen-preview">
            <div class="empty-state">
              <div class="empty-icon">üéØ</div>
              <div class="empty-title">Select a frame</div>
              <div class="empty-desc">Select a Frame or Component in Figma to see it here</div>
            </div>
          </div>
          <div class="version-info hidden" id="currentInfo">
            <div class="version-info-label">Selected:</div>
            <div class="version-info-name" id="currentName"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="status-bar">
    <div class="status-node" id="statusNode">
      <span>Select a Frame or Component</span>
    </div>
    <div>Design Diff v1.0</div>
  </div>

  <script>
    // OAuth Server URL - Î∞∞Ìè¨ ÌõÑ Î≥ÄÍ≤Ω ÌïÑÏöî
    const OAUTH_SERVER_URL = 'https://design-diff-oauth.vercel.app';
    
    // State
    let state = {
      token: null,
      fileKey: null,
      versions: [],
      selectedNode: null,
      selectedVersionId: null
    };
    
    // DOM Elements
    const connectScreen = document.getElementById('connectScreen');
    const mainView = document.getElementById('mainView');
    const connectBtn = document.getElementById('connectBtn');
    const tokenInput = document.getElementById('tokenInput');
    const saveTokenBtn = document.getElementById('saveTokenBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const previousVersionSelect = document.getElementById('previousVersionSelect');
    const previousPreview = document.getElementById('previousPreview');
    const currentPreview = document.getElementById('currentPreview');
    const currentInfo = document.getElementById('currentInfo');
    const currentName = document.getElementById('currentName');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusNode = document.getElementById('statusNode');
    
    // Format time
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleDateString('ko-KR', { 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // Update connection status
    function updateConnectionStatus(connected) {
      if (connected) {
        statusDot.classList.add('connected');
        statusText.textContent = 'Connected';
        disconnectBtn.classList.remove('hidden');
        connectScreen.classList.add('hidden');
        mainView.classList.remove('hidden');
      } else {
        statusDot.classList.remove('connected');
        statusText.textContent = 'Not connected';
        disconnectBtn.classList.add('hidden');
        connectScreen.classList.remove('hidden');
        mainView.classList.add('hidden');
      }
    }
    
    // Fetch version history
    async function fetchVersionHistory() {
      if (!state.token || !state.fileKey) return;
      
      try {
        const response = await fetch(
          `https://api.figma.com/v1/files/${state.fileKey}/versions`,
          {
            headers: { 'X-Figma-Token': state.token }
          }
        );
        
        if (!response.ok) throw new Error('Failed to fetch versions');
        
        const data = await response.json();
        state.versions = data.versions || [];
        
        // Populate dropdown
        previousVersionSelect.innerHTML = '<option value="">Select version...</option>';
        state.versions.forEach((v, i) => {
          const option = document.createElement('option');
          option.value = v.id;
          option.textContent = `v${state.versions.length - i} - ${v.label || formatTime(v.created_at)}`;
          previousVersionSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error fetching versions:', error);
      }
    }
    
    // Fetch version image
    async function fetchVersionImage(versionId, nodeId) {
      if (!state.token || !state.fileKey) return null;
      
      previousPreview.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <span>Loading version...</span>
        </div>
      `;
      
      try {
        const response = await fetch(
          `https://api.figma.com/v1/images/${state.fileKey}?ids=${encodeURIComponent(nodeId)}&version=${versionId}&format=png&scale=1`,
          {
            headers: { 'X-Figma-Token': state.token }
          }
        );
        
        if (!response.ok) throw new Error('Failed to fetch image');
        
        const data = await response.json();
        return data.images[nodeId];
        
      } catch (error) {
        console.error('Error fetching version image:', error);
        return null;
      }
    }
    
    // Event handlers
    connectBtn.addEventListener('click', () => {
      window.open(OAUTH_SERVER_URL, '_blank');
    });
    
    saveTokenBtn.addEventListener('click', () => {
      const token = tokenInput.value.trim();
      if (token) {
        parent.postMessage({ pluginMessage: { type: 'save-token', token } }, '*');
      }
    });
    
    tokenInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        saveTokenBtn.click();
      }
    });
    
    disconnectBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'clear-token' } }, '*');
    });
    
    previousVersionSelect.addEventListener('change', async () => {
      const versionId = previousVersionSelect.value;
      if (!versionId || !state.selectedNode) {
        previousPreview.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚èÆ</div>
            <div class="empty-title">Select a version</div>
            <div class="empty-desc">Choose a version from the dropdown to compare</div>
          </div>
        `;
        return;
      }
      
      state.selectedVersionId = versionId;
      const imageUrl = await fetchVersionImage(versionId, state.selectedNode.nodeId);
      
      if (imageUrl) {
        previousPreview.innerHTML = `<img src="${imageUrl}" alt="Previous version" class="fade-in">`;
      } else {
        previousPreview.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <div class="empty-title">Not found</div>
            <div class="empty-desc">This element may not exist in the selected version</div>
          </div>
        `;
      }
    });
    
    refreshBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'get-current-image' } }, '*');
    });
    
    // Message handler
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      switch (msg.type) {
        case 'init':
          state.token = msg.data.token;
          state.fileKey = msg.data.fileKey;
          
          if (state.token) {
            updateConnectionStatus(true);
            fetchVersionHistory();
          } else {
            updateConnectionStatus(false);
          }
          break;
          
        case 'token-saved':
          state.token = msg.data.token;
          updateConnectionStatus(true);
          fetchVersionHistory();
          break;
          
        case 'token-cleared':
          state.token = null;
          state.versions = [];
          updateConnectionStatus(false);
          break;
          
        case 'node-selected':
          state.selectedNode = msg.data;
          
          currentPreview.innerHTML = `<img src="${msg.data.imageData}" alt="Current" class="fade-in">`;
          currentName.textContent = msg.data.nodeName;
          currentInfo.classList.remove('hidden');
          
          statusNode.innerHTML = `
            <span class="status-node-type">${msg.data.nodeType}</span>
            <span>${msg.data.nodeName}</span>
          `;
          
          // Reset previous if version selected
          if (state.selectedVersionId) {
            previousVersionSelect.dispatchEvent(new Event('change'));
          }
          break;
          
        case 'selection-cleared':
          state.selectedNode = null;
          currentPreview.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üéØ</div>
              <div class="empty-title">Select a frame</div>
              <div class="empty-desc">Select a Frame or Component in Figma to see it here</div>
            </div>
          `;
          currentInfo.classList.add('hidden');
          statusNode.innerHTML = '<span>Select a Frame or Component</span>';
          break;
          
        case 'invalid-selection':
          statusNode.innerHTML = `<span style="color: var(--accent-red)">‚ö† ${msg.message}</span>`;
          break;
          
        case 'current-image':
          if (msg.data.imageData) {
            currentPreview.innerHTML = `<img src="${msg.data.imageData}" alt="Current" class="fade-in">`;
          }
          break;
      }
    };
  </script>
</body>
</html>
